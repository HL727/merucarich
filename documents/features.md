# メルカリッチ機能の概略

- メルカリッチは仕入元(Yahoo / メルカリ)からAmazonへの出品を補助するためのツール。
- 方法は画面から手動で出品する方法と、一括検索によって自動で出品する方法の2つがある
- 出品には Amazon に新しい商品を登録する「新規出品」と、既存のAmazonの出品アイテムに別の価格で出品する「相乗り出品」がある
  - 新規出品では新しい ASIN が割り振られる
  - 相乗り出品では既存の ASIN が利用される
- メルカリッチとは全く別のツールで検索した結果をメルカリッチに取り込むこともある
  - 別途配布している個人PC上で動くツール
  - Amazon出店者が利用できる出品一覧のCSVファイル
- メルカリッチ単体では Amazon に直接出品を行うことはない
  - 出品のためには CSV の出力を行い、それを Amazon に取り込むことなる
  - 出品したアイテムの在庫管理は行う
- ユーザーには個別のIPアドレスが設定されていることがある
  - サーバーから同一ネットワーク内の別のIPアドレスをバインドし、そのIPアドレスで通信を行うことがある
  - IPブロックを避けるための方法


# 一般機能の説明

- 各機能を使うためには、Amazon設定 > AmazonAPI設定 に入力が必要
- 正式なものを発行・取得するためには時間がかかるため、開発では適当な値を入力しても大丈夫
  - ただし、これを利用する機能は正常に動かないため、単体テストなどで機能検証はちゃんと行う
  - どうしても検証したい場合は本番環境で `python manage.py shell` で検証する (別ドキュメント参照)


## 商品リサーチ

手動での出品(新規・相乗り両方)を行える


## 一括データ作成

バックグラウンドワーカーを用いて、特定のAmazon商品ページを順にクロールしていき、そのアイテムに相乗り出品できるアイテムを主に探す

- Amazonに同一タイプのツールを用いて出展しているユーザー、かつ、ノーブランドのアイテムを基本的な探索対象としている
- 簡単に言うと以下のようなロジック
  - Amazonの商品名でヤフオク検索
  - 商品名・画像などから同じ商品かをチェック
  - 各種条件(現在販売価格、利益率など)を計算し、条件を満たすのであれば相乗り出品
  - 一部ユーザーでは相乗り出品できないが似たものを新規出品（新規出品候補）として一覧に保存する


画面から検索実行を指示できるが、実際の検索には一括検索用ワーカーが必要。

```bash
# 一括検索用バックグラウンド用ワーカー起動
pipenv run python manage.py runasyncworker
```


## 出品商品一覧

現在 CSV 出力が行われた (=Amazonに出品されたとシステムが認識している) アイテムの一覧を表示


## Amazon出品レポート取り込み

メルカリッチとは全く別のツールで検索した結果をメルカリッチに取り込むための機能

- 別途配布している個人PC上で動くツール
- Amazon出店者が利用できる出品一覧のCSVファイル

画面から取り込みを指示できるが、実際の取り込みには一括検索用ワーカーが必要。
ただし、AmazonAPIを利用しているので、Import部分は単体テストで代用して組み込んでいる。


```bash
# CSV取り込み用バックグラウンドワーカー起動
pipenv run python manage.py runasyncworker --queue-name import_queue
```


## 各種CSV出力

Amazonに出品するためのCSVファイルの出力を行う

- 出力されたCSVファイルは Amazon相乗り・新規出品用ファイルダウンロード画面からダウンロードする
- 一括検索では URL 毎の検索が終了する度にCSV出力を行うオプションがデフォルトでONになっているので注意


## 除外セラーID

ヤフオク・メルカリの出品者IDを指定して、そのセラーからは購入しないようにする。
ユーザー個別に加えて、システム管理者が設定する場合もある。


## Amazon設定

出品・自動化用のデフォルト値を設定する。


# 管理機能

２種類の管理機能がある。

## Django Admin 

http://localhost:8000/admin/ から入る機能で、Databaseの直接管理を行うことができる。


## AdminTools 

http://localhost:8000/ から「管理者権限」のユーザーでログインした場合に使える機能。

- IP Status Checker: ユーザーが利用しているIPアドレスが外部ツールと接続できるかをチェックする
- Edit xxxx: 特定ユーザー・全ユーザーに対して禁止する項目を設定する
- Edit ItemName Convert Rules: 一括検索で取得した商品名の変換ルールを定義する


# バッチ処理

cron で処理するバッチ処理がある。
その他、詳細は [環境設定](./environment.md) を参照。


## 在庫取り下げバッチ

ヤフオク・メルカリのアイテムは売り切れたり、出品期限が切れたりする。
そういった場合の状況を定期的に監視し、アイテムが売り切れていれば商品を取り下げる処理が必要になる。

それぞれ、以下の方法でバッチを起動する。

```bash
pipenv run python manage.py check_item_yahoo 2 4
pipenv run python manage.py check_item_mercari 2 4
```

なお、バッチは実際には対象を非同期ワーカーに投げるだけであり、実際の処理には事前にワーカーを起動しておく必要がある。

```bash
# Yahoo 在庫チェック用バックグラウンドワーカー起動
pipenv run python manage.py runasyncworker --queue-name invchk_yahoo
# Mercari 在庫チェック用バックグラウンドワーカー起動
pipenv run python manage.py runasyncworker --queue-name invchk_mercari
```


## 在庫復活バッチ

ヤフオクで１度期限がきれた場合、異なるオークションIDが割り振られることがある。
こういった場合、商品そのものは変わっていないので、在庫を復活させるというオペレーションが存在する。

以下の方法で在庫復活バッチを起動する。


```bash
pipenv run python manage.py update_item_yahoo 2 4
pipenv run python manage.py update_item_mercari 2 4
```

なお、バッチは実際には対象を非同期ワーカーに投げるだけであり、実際の処理には事前にワーカーを起動しておく必要がある。

```bash
# Yahoo 在庫復活用バックグラウンドワーカー起動
pipenv run python manage.py runasyncworker --queue-name invres_yahoo
# Mercari 在庫復活用バックグラウンドワーカー起動
pipenv run python manage.py runasyncworker --queue-name invres_mercari
```


## Amazonへの在庫反映バッチ

在庫チェックで増減した在庫を実際のAmazon商品(Feed)に反映するためのバッチ。
ただし、開発環境だと有効なAmazonAPIがないので、単体テストで検証を代用する。



# 本番環境での検証

一部の機能 (Amazon APIを使った機能) はどうしても本番環境で検証をしたいケースがある。
そういった場合は、Djangoのshell機能を使って、擬似的な検証を行う。

```bash
# root でログイン
su - richs

# カレントディレクトリを移動
cd /var/www/richs
# シェルモードで起動
python manage.py shell

>>> (ここでプログラムの検証を行う)
>>> (有効な AmazonAPI が設定されたユーザーを使った検証などが行える)
```


以上。
